import streamlit as st
import pandas as pd
import joblib
import base64
import datetime

# ุฅุนุฏุงุฏ ุงูุตูุญุฉ
st.set_page_config(page_title="ูุดู ุงูุชูุญุฏ", layout="centered")
st.markdown("""
<style>
    .stApp {
        direction: RTL;
        text-align: right;
        font-family: 'Cairo', sans-serif;
    }
</style>
""", unsafe_allow_html=True)

# ุชุญููู ุงูููุฏููุงุช
try:
    lr_model = joblib.load("logistic_model.pkl")
    rf_model = joblib.load("autism_detector_model.pkl")
    gnb_model = joblib.load("naive_bayes_model.pkl")
except FileNotFoundError as e:
    st.error(f"ุฎุทุฃ: ููู {e.filename} ุบูุฑ ููุฌูุฏ.")
    st.stop()

# ุงูุฃุณุฆูุฉ
behavioral_questions = [
    'ูู ูุณุชูุชุน ุงูุทูู ุจุงูุชุฃุฑุฌุญ ุฃู ุงูุชูุงูุฒ (ูุซู ุนูู ุงูุฃุฑุฌูุญุฉ ุฃู ุนูุฏ ุญููู)ุ',
    'ูู ูุจุฏู ุงูุทูู ุงูุชูุงููุง ุจุงูุฃุทูุงู ุงูุขุฎุฑูู (ูุซู ุงููุนุจ ูุนูู ุฃู ูุดุงูุฏุชูู)ุ',
    'ูู ูุญุจ ุงูุทูู ุงูุชุณูู ุนูู ุงูุฃุดูุงุก (ูุซู ุงูุณูุงูู ุฃู ุงูุฃุซุงุซ)ุ',
    'ูู ูุณุชูุชุน ุงูุทูู ุจูุนุจุฉ ุงูุบููุถุฉ ุฃู ุงููุดู (ูุซู ุฅุฎูุงุก ุงููุฌู ูุงูุธููุฑ)ุ',
    'ูู ููุงุฑุณ ุงูุทูู ุงููุนุจ ุงูุชุฎููู (ูุซู ุงูุชุธุงูุฑ ุจุงุณุชุฎุฏุงู ุงููุงุชู ุฃู ุงูุฏูู)ุ',
    'ูู ูุดูุฑ ุงูุทูู ุจุฅุตุจุน ุงูุณุจุงุจุฉ ูุทูุจ ุดูุก (ูุซู ูุนุจุฉ ุฃู ุทุนุงู)ุ',
    'ูู ูุดูุฑ ุงูุทูู ุจุฅุตุจุน ุงูุณุจุงุจุฉ ูุฅุธูุงุฑ ุงูุงูุชูุงู (ูุซู ุงูุฅุดุงุฑุฉ ุฅูู ุทุงุฆุฑ)ุ',
    'ูู ููุนุจ ุงูุทูู ุจุดูู ุตุญูุญ ูุน ุงูุฃูุนุงุจ ุงูุตุบูุฑุฉ (ูุซู ุชุฑููุจ ุงูููุนุจุงุช)ุ',
    'ูู ูุญุถุฑ ุงูุทูู ุฃุดูุงุก ููุธูุฑูุง ูู (ูุซู ูุนุจุฉ ุฃู ูุชุงุจ)ุ',
    'ูู ูุญุงูุธ ุงูุทูู ุนูู ุงูุชูุงุตู ุงูุจุตุฑู ูุนู ูุฃูุซุฑ ูู ุซุงููุฉ ูู ูู ูุฑุฉุ'
]

# ุฅุฌุงุจุงุช ุงูุชูุญุฏ
autism_answers = {
    'ูู ูุณุชูุชุน ุงูุทูู ุจุงูุชุฃุฑุฌุญ ุฃู ุงูุชูุงูุฒ (ูุซู ุนูู ุงูุฃุฑุฌูุญุฉ ุฃู ุนูุฏ ุญููู)ุ': 'ูุนู',
    'ูู ูุจุฏู ุงูุทูู ุงูุชูุงููุง ุจุงูุฃุทูุงู ุงูุขุฎุฑูู (ูุซู ุงููุนุจ ูุนูู ุฃู ูุดุงูุฏุชูู)ุ': 'ูุง',
    'ูู ูุญุจ ุงูุทูู ุงูุชุณูู ุนูู ุงูุฃุดูุงุก (ูุซู ุงูุณูุงูู ุฃู ุงูุฃุซุงุซ)ุ': 'ูุนู',
    'ูู ูุณุชูุชุน ุงูุทูู ุจูุนุจุฉ ุงูุบููุถุฉ ุฃู ุงููุดู (ูุซู ุฅุฎูุงุก ุงููุฌู ูุงูุธููุฑ)ุ': 'ูุง',
    'ูู ููุงุฑุณ ุงูุทูู ุงููุนุจ ุงูุชุฎููู (ูุซู ุงูุชุธุงูุฑ ุจุงุณุชุฎุฏุงู ุงููุงุชู ุฃู ุงูุฏูู)ุ': 'ูุง',
    'ูู ูุดูุฑ ุงูุทูู ุจุฅุตุจุน ุงูุณุจุงุจุฉ ูุทูุจ ุดูุก (ูุซู ูุนุจุฉ ุฃู ุทุนุงู)ุ': 'ูุง',
    'ูู ูุดูุฑ ุงูุทูู ุจุฅุตุจุน ุงูุณุจุงุจุฉ ูุฅุธูุงุฑ ุงูุงูุชูุงู (ูุซู ุงูุฅุดุงุฑุฉ ุฅูู ุทุงุฆุฑ)ุ': 'ูุง',
    'ูู ููุนุจ ุงูุทูู ุจุดูู ุตุญูุญ ูุน ุงูุฃูุนุงุจ ุงูุตุบูุฑุฉ (ูุซู ุชุฑููุจ ุงูููุนุจุงุช)ุ': 'ูุง',
    'ูู ูุญุถุฑ ุงูุทูู ุฃุดูุงุก ููุธูุฑูุง ูู (ูุซู ูุนุจุฉ ุฃู ูุชุงุจ)ุ': 'ูุง',
    'ูู ูุญุงูุธ ุงูุทูู ุนูู ุงูุชูุงุตู ุงูุจุตุฑู ูุนู ูุฃูุซุฑ ูู ุซุงููุฉ ูู ูู ูุฑุฉุ': 'ูุง'
}

# ุฃูุฒุงู ุงูุฃุณุฆูุฉ
weights = {
    'ูู ูุณุชูุชุน ุงูุทูู ุจุงูุชุฃุฑุฌุญ ุฃู ุงูุชูุงูุฒ (ูุซู ุนูู ุงูุฃุฑุฌูุญุฉ ุฃู ุนูุฏ ุญููู)ุ': 0.91,
    'ูู ูุจุฏู ุงูุทูู ุงูุชูุงููุง ุจุงูุฃุทูุงู ุงูุขุฎุฑูู (ูุซู ุงููุนุจ ูุนูู ุฃู ูุดุงูุฏุชูู)ุ': 0.91,
    'ูู ูุญุจ ุงูุทูู ุงูุชุณูู ุนูู ุงูุฃุดูุงุก (ูุซู ุงูุณูุงูู ุฃู ุงูุฃุซุงุซ)ุ': 0.91,
    'ูู ูุณุชูุชุน ุงูุทูู ุจูุนุจุฉ ุงูุบููุถุฉ ุฃู ุงููุดู (ูุซู ุฅุฎูุงุก ุงููุฌู ูุงูุธููุฑ)ุ': 1.36,
    'ูู ููุงุฑุณ ุงูุทูู ุงููุนุจ ุงูุชุฎููู (ูุซู ุงูุชุธุงูุฑ ุจุงุณุชุฎุฏุงู ุงููุงุชู ุฃู ุงูุฏูู)ุ': 0.91,
    'ูู ูุดูุฑ ุงูุทูู ุจุฅุตุจุน ุงูุณุจุงุจุฉ ูุทูุจ ุดูุก (ูุซู ูุนุจุฉ ุฃู ุทุนุงู)ุ': 0.91,
    'ูู ูุดูุฑ ุงูุทูู ุจุฅุตุจุน ุงูุณุจุงุจุฉ ูุฅุธูุงุฑ ุงูุงูุชูุงู (ูุซู ุงูุฅุดุงุฑุฉ ุฅูู ุทุงุฆุฑ)ุ': 0.91,
    'ูู ููุนุจ ุงูุทูู ุจุดูู ุตุญูุญ ูุน ุงูุฃูุนุงุจ ุงูุตุบูุฑุฉ (ูุซู ุชุฑููุจ ุงูููุนุจุงุช)ุ': 0.91,
    'ูู ูุญุถุฑ ุงูุทูู ุฃุดูุงุก ููุธูุฑูุง ูู (ูุซู ูุนุจุฉ ุฃู ูุชุงุจ)ุ': 0.91,
    'ูู ูุญุงูุธ ุงูุทูู ุนูู ุงูุชูุงุตู ุงูุจุตุฑู ูุนู ูุฃูุซุฑ ูู ุซุงููุฉ ูู ูู ูุฑุฉุ': 1.36,
    'ูู ุนุงูู ูู ุงูุตูุฑุงุก ุนูุฏ ุงูููุงุฏุฉ': 0.01,
    'ูู ููุฌุฏ ุชุงุฑูุฎ ุนุงุฆูู ูุน ุงูุชูุญุฏ': 0.01,
    'ูู ุชู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ูู ูุจู': 0.01
}

# ุชูุณูู ุงูุฃุณุฆูุฉ
social_play = [
    behavioral_questions[1],  # ูู ูุจุฏู ุงูุทูู ุงูุชูุงููุง...
    behavioral_questions[3],  # ูู ูุณุชูุชุน ุงูุทูู ุจูุนุจุฉ ุงูุบููุถุฉ...
    behavioral_questions[4]   # ูู ููุงุฑุณ ุงูุทูู ุงููุนุจ ุงูุชุฎููู...
]
physical_activity = [
    behavioral_questions[0],  # ูู ูุณุชูุชุน ุงูุทูู ุจุงูุชุฃุฑุฌุญ...
    behavioral_questions[2]   # ูู ูุญุจ ุงูุทูู ุงูุชุณูู...
]
communication_engagement = behavioral_questions[5:]  # ุงูุฅุดุงุฑุฉ ูุทูุจุ ุงูุฅุดุงุฑุฉ ููุงูุชูุงูุ ุงููุนุจ ุจุงูุฃูุนุงุจุ ุฅุธูุงุฑ ุงูุฃุดูุงุกุ ุงูุชูุงุตู ุงูุจุตุฑู

# ุฎูุงุฑุงุช ุงูุฅุฏุฎุงู
gender_options = ['ุงุฎุชุฑ...', 'ุฃูุซู', 'ุฐูุฑ']
ethnicity_options = ['ุงุฎุชุฑ...', *sorted(['ุขุณููู', 'ุฃูุฑููู', 'ุฃูุฑูุจู', 'ุชุฑูู', 'ุฌุฒุฑ ุงููุญูุท ุงููุงุฏุฆ', 'ุฌููุจ ุขุณููู', 'ุนุฑุจู', 'ุบูุฑ ูุนุฑูู', 'ูุงุชููู'])]
residence_options = ['ุงุฎุชุฑ...', *sorted(['ุฃุณุชุฑุงููุง', 'ุฃูุบุงูุณุชุงู', 'ุฃูุฑูุจุง', 'ุฅูุทุงููุง', 'ุงูุฃุฑุฏู', 'ุงูุฃุฑุฌูุชูู', 'ุงูุฅูุงุฑุงุช ุงูุนุฑุจูุฉ ุงููุชุญุฏุฉ', 'ุงูุจุญุฑูู', 'ุงูุจุฑุงุฒูู', 'ุงูุณููุฏ', 'ุงูุตูู', 'ุงูุนุฑุงู', 'ุงููููุช', 'ุงูููุณูู', 'ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ', 'ุงูููููุฉ ุงููุชุญุฏุฉ', 'ุงูููุณุง', 'ุงููุงุจุงู', 'ุจุงูุณุชุงู', 'ุจูุบูุงุฏูุด', 'ุจูุชุงู', 'ุชุฑููุง', 'ุฌุฒุฑ ุงูููุงูุงุช ุงููุชุญุฏุฉ ุงููุงุฆูุฉ', 'ุฌุฒูุฑุฉ ูุงู', 'ุฌูุฑุฌูุง', 'ุฑูุณูุง', 'ุฑููุงููุง', 'ุณูุฑูุง', 'ุฌููุจ ุฅูุฑูููุง', 'ุบุงูุง', 'ูุทุฑ', 'ููุฏุง', 'ููุฑูุง ุงูุฌููุจูุฉ', 'ููุณุชุงุฑููุง', 'ูุงุชููุง', 'ูุจูุงู', 'ููุจูุง', 'ูุงูุทุง', 'ูุงููุฒูุง', 'ูุตุฑ', 'ููุจุงู', 'ูููุฒูููุฏุง', 'ููููุฏุง', 'ุงูููุงูุงุช ุงููุชุญุฏุฉ', 'ุนูุงู', 'ุงูููุจูู'])]
relation_options = ['ุงุฎุชุฑ...', *sorted(['ุฃุฎุตุงุฆู ุฑุนุงูุฉ ุตุญูุฉ', 'ุฐุงุชู', 'ูุฑูุจ', 'ุบูุฑ ูุนุฑูู', 'ูุงูุฏ/ูุงูุฏุฉ'])]

st.title("๐ง ุฃุฏุงุฉ ูุดู ุงุถุทุฑุงุจ ุทูู ุงูุชูุญุฏ")

user_inputs = {}
with st.form("autism_form"):
    st.subheader("๐ ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ")
    user_inputs['ุงูุงุณู'] = st.text_input("ุงุณู ุงูุทูู", placeholder="ุฃุฏุฎู ุงุณู ุงูุทูู")
    user_inputs['ุงูุนูุฑ'] = st.number_input("ุงูุนูุฑ (ุจุงูุณููุงุช)", min_value=1, step=1, value=None, placeholder="ุฃุฏุฎู ุนูุฑ ุงูุทูู")
    user_inputs['ุงูุนูุงูุฉ'] = st.selectbox("ุงูุนูุงูุฉ", relation_options, index=None, placeholder="ุงุฎุชุฑ ุงูุนูุงูุฉ")

    st.subheader("๐ซ ุงูุชูุงุนู ุงูุงุฌุชูุงุนู ูุงููุนุจ")
    for q in social_play:
        user_inputs[q] = st.radio(q, ['ูุนู', 'ูุง'], index=None, key=q)

    st.subheader("๐คธโโ๏ธ ุงููุดุงุท ุงูุฌุณุฏู")
    for q in physical_activity:
        user_inputs[q] = st.radio(q, ['ูุนู', 'ูุง'], index=None, key=q)

    st.subheader("๐ฃ๏ธ ุงูุชูุงุตู ูุงูุงูุฎุฑุงุท")
    for q in communication_engagement:
        user_inputs[q] = st.radio(q, ['ูุนู', 'ูุง'], index=None, key=q)

    st.subheader("๐ ูุนูููุงุช ุฅุถุงููุฉ")
    user_inputs['ุงูุฌูุณ'] = st.selectbox("ุงูุฌูุณ", gender_options, index=None, placeholder="ุงุฎุชุฑ ุงูุฌูุณ")
    user_inputs['ุงูุนุฑู / ุงูุฃุตู ุงูุฌุบุฑุงูู'] = st.selectbox("ุงูุนุฑู / ุงูุฃุตู ุงูุฌุบุฑุงูู", ethnicity_options, index=None, placeholder="ุงุฎุชุฑ ุงูุนุฑู / ุงูุฃุตู ุงูุฌุบุฑุงูู")
    user_inputs['ูู ุนุงูู ูู ุงูุตูุฑุงุก ุนูุฏ ุงูููุงุฏุฉ'] = st.radio("ูู ุนุงูู ูู ุงูุตูุฑุงุก ุนูุฏ ุงูููุงุฏุฉ", ['ูุนู', 'ูุง'], index=None, key='ุตูุฑุงุก')
    user_inputs['ูู ููุฌุฏ ุชุงุฑูุฎ ุนุงุฆูู ูุน ุงูุชูุญุฏ'] = st.radio("ูู ููุฌุฏ ุชุงุฑูุฎ ุนุงุฆูู ูุน ุงูุชูุญุฏ", ['ูุนู', 'ูุง'], index=None, key='ุชุงุฑูุฎ')
    user_inputs['ุจูุฏ ุงูุฅูุงูุฉ'] = st.selectbox("ุจูุฏ ุงูุฅูุงูุฉ", residence_options, index=None, placeholder="ุงุฎุชุฑ ุจูุฏ ุงูุฅูุงูุฉ")
    user_inputs['ูู ุชู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ูู ูุจู'] = st.radio("ูู ุชู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ูู ูุจู", ['ูุนู', 'ูุง'], index=None, key='ุชุทุจูู')

    submitted = st.form_submit_button("๐ ุชููุน")

if submitted:
    # ุงูุชุญูู ูู ุงูุฅุฏุฎุงูุงุช
    missing_fields = []
    for q in behavioral_questions + ['ูู ุนุงูู ูู ุงูุตูุฑุงุก ุนูุฏ ุงูููุงุฏุฉ', 'ูู ููุฌุฏ ุชุงุฑูุฎ ุนุงุฆูู ูุน ุงูุชูุญุฏ', 'ูู ุชู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ูู ูุจู']:
        if user_inputs.get(q) not in ['ูุนู', 'ูุง']:
            missing_fields.append(q)
    for field in ['ุงูุฌูุณ', 'ุงูุนุฑู / ุงูุฃุตู ุงูุฌุบุฑุงูู', 'ุจูุฏ ุงูุฅูุงูุฉ', 'ุงูุนูุงูุฉ']:
        if user_inputs.get(field) in [None, 'ุงุฎุชุฑ...']:
            missing_fields.append(field)
    if not user_inputs.get('ุงูุงุณู'):
        missing_fields.append('ุงูุงุณู')
    if user_inputs.get('ุงูุนูุฑ') is None:
        missing_fields.append('ุงูุนูุฑ')

    if missing_fields:
        st.error(f"ูุฑุฌู ููุก ุฌููุน ุงูุญููู ุงูุชุงููุฉ: {', '.join(missing_fields)}")
    else:
        # ุชุญูู ุฅุถุงูู ููุชุฃูุฏ ูู ูุฌูุฏ ูู ุงูุฃุณุฆูุฉ ูู user_inputs
        for q in behavioral_questions:
            if q not in user_inputs or user_inputs[q] not in ['ูุนู', 'ูุง']:
                st.error(f"ุฎุทุฃ: ุฅุฌุงุจุฉ ุงูุณุคุงู '{q}' ุบูุฑ ููุฌูุฏุฉ ุฃู ุบูุฑ ุตุญูุญุฉ.")
                st.stop()

        # ุชุญุถูุฑ ุงูุฅุฏุฎุงู
        binary_map = {'ูุนู': 1, 'ูุง': 0}
        input_data = {q: binary_map[user_inputs[q]] for q in behavioral_questions}
        input_data['ุงูุนูุฑ'] = user_inputs['ุงูุนูุฑ']
        input_data['ุงูุฌูุณ'] = gender_options.index(user_inputs['ุงูุฌูุณ']) - 1
        input_data['ุงูุนุฑู / ุงูุฃุตู ุงูุฌุบุฑุงูู'] = ethnicity_options.index(user_inputs['ุงูุนุฑู / ุงูุฃุตู ุงูุฌุบุฑุงูู']) - 1
        input_data['ูู ุนุงูู ูู ุงูุตูุฑุงุก ุนูุฏ ุงูููุงุฏุฉ'] = 0  # ุฅูุบุงุก ุชุฃุซูุฑ
        input_data['ูู ููุฌุฏ ุชุงุฑูุฎ ุนุงุฆูู ูุน ุงูุชูุญุฏ'] = 0   # ุฅูุบุงุก ุชุฃุซูุฑ
        input_data['ูู ุชู ุงุณุชุฎุฏุงู ุงูุชุทุจูู ูู ูุจู'] = 0    # ุฅูุบุงุก ุชุฃุซูุฑ
        input_data['ุจูุฏ ุงูุฅูุงูุฉ'] = residence_options.index(user_inputs['ุจูุฏ ุงูุฅูุงูุฉ']) - 1
        input_data['ุงูุนูุงูุฉ'] = relation_options.index(user_inputs['ุงูุนูุงูุฉ']) - 1
        input_data['ุงููุฌููุน'] = sum(input_data[q] for q in behavioral_questions)

        # ุฅูุดุงุก DataFrame
        df_input = pd.DataFrame([input_data])

        # ุงูุชุฃูุฏ ูู ูุทุงุจูุฉ ุงูุฃุนูุฏุฉ
        expected_columns = lr_model.feature_names_in_
        if not all(col in df_input.columns for col in expected_columns) or not all(col in expected_columns for col in df_input.columns):
            missing_cols = [col for col in expected_columns if col not in df_input.columns]
            extra_cols = [col for col in df_input.columns if col not in expected_columns]
            st.error(f"ุฎุทุฃ ูู ุงูุฃุนูุฏุฉ: \n- ุงูุฃุนูุฏุฉ ุงููุงูุตุฉ: {missing_cols}\n- ุงูุฃุนูุฏุฉ ุงูุฒูุงุฏุฉ: {extra_cols}")
            st.stop()

        # ุชุฑุชูุจ ุงูุฃุนูุฏุฉ ุญุณุจ ุงููููุฐุฌ
        df_input = df_input[expected_columns]

        # ุงูุชููุน
        prob_lr = lr_model.predict_proba(df_input)[0][1]
        prob_rf = rf_model.predict_proba(df_input)[0][1]
        prob_gnb = gnb_model.predict_proba(df_input)[0][1]
        final_prob = 0.05 * prob_lr + 0.90 * prob_rf + 0.05 * prob_gnb
        # ุถุจุท ุงููุณุจุฉ ุงููููุฉ
        if all(user_inputs[q] == autism_answers[q] for q in behavioral_questions):
            final_prob = min(0.98 + (final_prob * 0.02), 1.0)
        final_pred = 1 if final_prob > 0.5 else 0

        st.subheader("๐ ุงููุชูุฌุฉ")
        if final_pred:
            st.error(f"โ๏ธ ููุฌุฏ ุงุญุชูุงู ููุฅุตุงุจุฉ ุจุงูุชูุญุฏ ุจูุณุจุฉ {final_prob*100:.2f}%")
        else:
            st.success(f"โ ูุง ููุฌุฏ ุงุญุชูุงู ูุงุถุญ ููุชูุญุฏุ ุงููุณุจุฉ {final_prob*100:.2f}%")

        # ุญุณุงุจ ุงููุณุจ ุจูุงุกู ุนูู ุฅุฌุงุจุงุช ุงูุชูุญุฏ ูุน ุงูุฃูุฒุงู
        try:
            social_score = sum(weights[q] for q in social_play if user_inputs[q] == autism_answers[q])
            social_total_weight = sum(weights[q] for q in social_play)
            physical_score = sum(weights[q] for q in physical_activity if user_inputs[q] == autism_answers[q])
            physical_total_weight = sum(weights[q] for q in physical_activity)
            comm_score = sum(weights[q] for q in communication_engagement if user_inputs[q] == autism_answers[q])
            comm_total_weight = sum(weights[q] for q in communication_engagement)
        except KeyError as e:
            st.error(f"ุฎุทุฃ: ุงูุณุคุงู '{e}' ุบูุฑ ููุฌูุฏ ูู ุงูุฃูุฒุงู ุฃู ุฅุฌุงุจุงุช ุงูุชูุญุฏ.")
            st.stop()

        # ุญุณุงุจ ุงููุณุจ ุงููุฆููุฉ ุจูุงุกู ุนูู ุชูุฒูุน final_prob
        total_score = social_score + physical_score + comm_score
        if total_score > 0:
            social_percentage = (social_score / total_score) * (final_prob * 100)
            physical_percentage = (physical_score / total_score) * (final_prob * 100)
            comm_percentage = (comm_score / total_score) * (final_prob * 100)
            # ุถุจุท ุงููุณุจ ูุถูุงู ุงููุฌููุน ูุณุงูู final_prob * 100
            total_percentage = social_percentage + physical_percentage + comm_percentage
            if total_percentage != final_prob * 100:
                diff = (final_prob * 100) - total_percentage
                # ุฅุถุงูุฉ ุงููุฑู ุฅูู ุฃูุจุฑ ูุณุจุฉ
                if comm_percentage >= social_percentage and comm_percentage >= physical_percentage:
                    comm_percentage += diff
                elif social_percentage >= physical_percentage:
                    social_percentage += diff
                else:
                    physical_percentage += diff
        else:
            social_percentage = 0.0
            physical_percentage = 0.0
            comm_percentage = 0.0

        # ุนุฑุถ ุงููุณูุจ ูู ุงููุงุฌูุฉ
        st.markdown(f"๐ซ ุงูุชูุงุนู ุงูุงุฌุชูุงุนู ูุงููุนุจ: {social_percentage:.2f}% ({social_score:.1f} ูู {social_total_weight:.1f} ุฏุฑุฌุฉ)")
        st.markdown(f"๐คธโโ๏ธ ุงููุดุงุท ุงูุฌุณุฏู: {physical_percentage:.2f}% ({physical_score:.1f} ูู {physical_total_weight:.1f} ุฏุฑุฌุฉ)")
        st.markdown(f"๐ฃ๏ธ ุงูุชูุงุตู ูุงูุงูุฎุฑุงุท: {comm_percentage:.2f}% ({comm_score:.1f} ูู {comm_total_weight:.1f} ุฏุฑุฌุฉ)")

        # ุฅูุดุงุก ููุงุฆู ุงูุฃุณุฆูุฉ ูุฅุฌุงุจุงุชูุง ููู ุณูุดู
        social_answers = "\n".join([f"- {q}: {user_inputs[q]}" for q in social_play])
        physical_answers = "\n".join([f"- {q}: {user_inputs[q]}" for q in physical_activity])
        comm_answers = "\n".join([f"- {q}: {user_inputs[q]}" for q in communication_engagement])

        # ุฅูุดุงุก ุงูุชูุฑูุฑ ูุน ุชูุถูุญ
        report = f"""
ุชูุฑูุฑ ูุดู ุงูุชูุญุฏ
------------------------
ุงูุชุงุฑูุฎ: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
ุงูุงุณู: {user_inputs['ุงูุงุณู']}
ุงูุนูุฑ: {user_inputs['ุงูุนูุฑ']}
ุงูุนูุงูุฉ: {user_inputs['ุงูุนูุงูุฉ']}

ุงููุชูุฌุฉ: {'ุฅูุฌุงุจู' if final_pred else 'ุณูุจู'}
ูุณุจุฉ ุงูุงุญุชูุงู: {final_prob*100:.2f}%

=== ุชุญููู ุงูุณููููุงุช ===
ุชุนูุณ ุงููุณุจ ุงูุชุงููุฉ ูุณุงููุฉ ูู ูุณู ูู ุงูุณููููุงุช ุงููุฑุชุจุทุฉ ุจุงุถุทุฑุงุจ ุทูู ุงูุชูุญุฏ ูู ุงููุณุจุฉ ุงูุฅุฌูุงููุฉ ููุงุญุชูุงูุ ุจูุงุกู ุนูู ุงูุฅุฌุงุจุงุช ุงูุชู ุชุชุทุงุจู ูุน ุงูุณููููุงุช ุงููุฑุชุจุทุฉ ุจุงูุชูุญุฏ. ุชู ุชูุฒูุน ุงููุณุจุฉ ุงูุฅุฌูุงููุฉ ({final_prob*100:.2f}%) ุนูู ุงูุฃูุณุงู ุจูุงุกู ุนูู ุฏุฑุฌุงุชูุง ุงููุณุจูุฉ.

๐ซ ุงูุชูุงุนู ุงูุงุฌุชูุงุนู ูุงููุนุจ: {social_percentage:.2f}% ({social_score:.1f} ูู {social_total_weight:.1f} ุฏุฑุฌุฉ)
{social_answers}

๐คธโโ๏ธ ุงููุดุงุท ุงูุฌุณุฏู: {physical_percentage:.2f}% ({physical_score:.1f} ูู {physical_total_weight:.1f} ุฏุฑุฌุฉ)
{physical_answers}

๐ฃ๏ธ ุงูุชูุงุตู ูุงูุงูุฎุฑุงุท: {comm_percentage:.2f}% ({comm_score:.1f} ูู {comm_total_weight:.1f} ุฏุฑุฌุฉ)
{comm_answers}

---
"""
        b64 = base64.b64encode(report.encode()).decode()
        href = f'<a href="data:text/plain;base64,{b64}" download="autism_report.txt">๐ฅ ุชุญููู ุงูุชูุฑูุฑ</a>'
        st.markdown(href, unsafe_allow_html=True)

# ุงูุดุฑูุท ุงูุฌุงูุจู
st.sidebar.markdown("""
### โน๏ธ ุฏููู ุฅุฑุดุงุฏู
ููุนุฑูุฉ ุงููุฒูุฏ ุนู ุงูุชูุญุฏ ูุทุฑู ุงูุชุนุงูู ูุน ุงูุทููุ ุฒุฑ ุงููููุน:
[ููุธูุฉ ุงูุชูุญุฏ ุงูุนุงูููุฉ](https://www.autismspeaks.org)
""")

st.markdown("---")
st.markdown("ยฉ 2025 ุฃุฏุงุฉ ูุดู ุงูุชูุญุฏ")
st.markdown("ุชุทููุฑ: [ุฃุญูุฏ ุนุซูุงู]")